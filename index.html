<!--Alejandro Guayaquil-->
<!--09.2015-->

<!--Example to welcome the awesomeness of WebGL-->
<!--I have few knowledge of layouts using HTML and CSS so I will-->
<!--have to improve such skils for this project-->
<!--The same goes for how to code nicely in Javascript-->

<!DOCTYPE html>
<html>
<head>
    <title>WebGL Toy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Fetch the math library-->
    <script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>

    <!--jQuery-->
    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">

<script id="shader-vs" type="x-shader/x-vertex">/// Alejandro Guayaquil 
/// 10.2015 

/// Check what is the purpose of this line
precision mediump float;

/// Properties per vertex
attribute vec3 aVertexPosition;
attribute vec2 aVertexTexture;
attribute vec3 aVertexNormal;

/// Variable from the CPU
uniform float uTime;

/// The model-view-projection
uniform mat4 uM;
uniform mat4 uV;
uniform mat4 uP;

/// Output variables for next stages
varying vec2 vTexture;
varying vec3 vNormal;
varying vec4 vVertex;

void main(void)
{
    vTexture = aVertexTexture;
    vNormal = aVertexNormal;

    vVertex = (uV * uM) * vec4(aVertexPosition, 1.0);
    gl_Position = uP * vVertex;
}</script>
<script id="shader-fs" type="x-shader/x-fragment">/// Alejandro Guayaquil
/// 09.2015

/// Check what is the purpose of this line
precision mediump float;

/// Input from previous stages
varying vec2 vTexture;
varying vec3 vNormal;
varying vec4 vColor;

/// Toggle texture
uniform int uToggleTexture;

/// ID for the texture
uniform sampler2D uSamplerTexture;

void main(void)
{
    if (uToggleTexture > 0)
    {
        /// Fecth the coordinates from the image and apply to the pixel
        gl_FragColor = texture2D(uSamplerTexture, vTexture);
    }
    else
    {
        /// Cube has color per face (:
        gl_FragColor = vColor;
    }
}</script>
<script id="shader-fs-phong-shading" type="x-shader/x-fragment">/// Alejandro Guayaquil
/// 10.2015

/// Check what is the purpose of this line
precision mediump float;

/// Input from previous stages
varying vec2 vTexture;
varying vec4 vVertex;
varying vec3 vNormal;

/// Lighting requires the view and normal matrix, just once not per vertex or fragment
uniform mat4 uV;
uniform mat3 uN;

/// Light materials
uniform vec3 uLightAmbient;
uniform vec3 uLightDiffuse;
uniform vec3 uLightSpecular;
uniform vec4 uLightPosition;

/// Toggle texture
uniform int uToggleTexture;

/// ID for the texture
uniform sampler2D uSamplerTexture;

void main(void)
{
    vec3 material;
    if (uToggleTexture > 0)
    {
        /// Fecth the coordinates from the image and apply to the pixel
        material = texture2D(uSamplerTexture, vTexture).xyz;
    }
    else
    {
        material = vec3(1, 1, 1);
    }

    /// Maybe is too expensive to do the norm in the shader ... 

    vec3 v = -vVertex.xyz;
    float vLength = length(v);
    if (vLength  > 0.0)
    {
        v /= vLength;
    }

    vec3 l = ((uV * uLightPosition).xyz - vVertex.xyz);
    float lLength = length(l);
    if (lLength > 0.0)
    {
        l /= lLength;
    }

    vec3 n = uN * vNormal;
    vec3 r = reflect(-l, n);

    /// Compute light contributions
    vec3 ambient = (uLightAmbient * material);
    vec3 diffuse = (uLightDiffuse * material) * max(dot(n, l), 0.0);

    vec3 specular = vec3(0.0, 0.0, 0.0);
    float factor = dot(r, v);
    if (factor > 0.0)
    {
        specular = (uLightSpecular * material) * pow(factor, 10.0);
    }

    gl_FragColor = vec4(ambient + diffuse + specular, 1.0);
}</script>

<script id="shader-gs" type="x-shader/x-geometry">/// Not active</script>
<script id="shader-cs" type="x-shader/x-tessellationcontrol">/// Not active</script>
<script id="shader-es" type="x-shader/x-tessellationevaluation">/// Not active</script>

    <!-- Procedural objects ... maybe set from there ...  -->
    <script type="text/javascript" src="src/box.js"></script>

    <!-- External models ... more robust please -->
    <!--<script type="text/javascript" src="src/meshloader.js"></script>-->

    <script type="text/javascript" src="src/textures.js"></script>
    <script type="text/javascript" src="src/shaders.js"></script>
    <script type="text/javascript" src="src/resize.js"></script>
    <script type="text/javascript" src="src/initgl.js"></script>
    <script type="text/javascript" src="src/draw.js"></script>

    <!--<script src="src/globals.js" type="text/javascript"></script>-->
    <script type="text/javascript">
        localStorage.setItem("modelID", "-1");


        var animation = false;
        var toggletex = false;

        /// Math stuff
        var projectionMatrix = mat4.create();
        var normalMatrix = mat3.create();
        var modelMatrix = mat4.create();
        var viewMatrix = mat4.create();
        var mvMatrix = mat4.create();

        function setMatrixUniforms()
        {
            gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, projectionMatrix);
            gl.uniformMatrix3fv(shaderProgram.nMatrixUniform, false, normalMatrix);
            gl.uniformMatrix4fv(shaderProgram.mMatrixUniform, false, modelMatrix);
            gl.uniformMatrix4fv(shaderProgram.vMatrixUniform, false, viewMatrix);
        }

        /// Animation
        var timeClientSite = 0;

        function setUniforms()
        {
            if (animation)
            {
                /// I think I should add some condition to not exceed a huge number ...
                timeClientSite += 1;

                if (timeClientSite > 360)
                {
                    timeClientSite = 0;
                }
            }

            gl.uniform1f(shaderProgram.timeUniform, timeClientSite);
            gl.uniform1i(shaderProgram.samplerUniform, 0);

            /// Lighting
            var position = [0.0, 100.0, 0.0, 1.0];
            var specular = [1.0, 1.0, 1.0];
            var diffuse = [0.5, 0.5, 0.5];
            var ambient = [0.1, 0.1, 0.1];

            gl.uniform4fv(shaderProgram.pLightUniform, position);
            gl.uniform3fv(shaderProgram.sLightUniform, specular);
            gl.uniform3fv(shaderProgram.dLightUniform, diffuse);
            gl.uniform3fv(shaderProgram.aLightUniform, ambient);
        }

        /// Update
        function tick()
        {
            /// http://learningwebgl.com/blog/?p=3189
            requestAnimationFrame(tick);
            drawScene();
        }

        /// Toggle Animation
        function toggleAnimation()
        {
            animation = !animation;
        }

        /// Toggle texture
        function toggleTexture()
        {
            toggletex = !toggletex;
            gl.uniform1i(shaderProgram.toggleTexture, toggletex);
        }

        /// Reload texture
        function reloadTextureImage()
        {
            /// For loading of another computer I will have to read about this
            /// https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS
            var urlText = document.getElementById("inputURLImage").value;
            initTextures(urlText);
        }

        /// Initializer
        function WebGLInitializer()
        {
            /// Create context
            initGL();

            /// Load the beautiful shaders
            loadShaders();

            /// Load the image
            initTextures("images/Brick.jpg");

            /// Load the model
            //loadMesh("Teapot.json");

            /// Load procedural objects
            loadCubeColorPerFace();

            /// Launch
            gl.clearColor(1.0, 1.0, 1.0, 1.0);
            gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
            gl.enable(gl.DEPTH_TEST);
            gl.enable(gl.BLEND);

            tick();
        }

        function saveRender()
        {
            var canvas = document.getElementById("WebGLCanvas");
            var img = canvas.toDataURL("image/png");
        }

        $(document).ready(function () {
            $("#inputVS").append($("#shader-vs").text());
            $("#inputFS").append($("#shader-fs-phong-shading").text());
            $("#inputGS").append($("#shader-gs").text());
            $("#inputES").append($("#shader-es").text());
            $("#inputCS").append($("#shader-cs").text());

            /// Works the highlight and the editing on the fly
            var textAreaVS = document.getElementById("inputVS");
            editorVS = CodeMirror.fromTextArea(textAreaVS, {
                mode: "text/x-csrc",
                lineNumbers: true,
                matchBrackets: true,
            });

            var textAreaFS = document.getElementById("inputFS");
            editorFS = CodeMirror.fromTextArea(textAreaFS, {
                mode: "text/x-csrc",
                lineNumbers: true,
                matchBrackets: true
            });
            
            var textAreaGS = document.getElementById("inputGS");
            editorGS = CodeMirror.fromTextArea(textAreaGS, {
                mode: "text/x-csrc",
                lineNumbers: true,
                matchBrackets: true
            });
            editorGS.setSize($(this).width(), 25);

            var textAreaES = document.getElementById("inputES");
            editorES = CodeMirror.fromTextArea(textAreaES, {
                mode: "text/x-csrc",
                lineNumbers: true,
                matchBrackets: true
            });
            editorES.setSize($(this).width(), 25);

            var textAreaCS = document.getElementById("inputCS");
            editorCS = CodeMirror.fromTextArea(textAreaCS, {
                mode: "text/x-csrc",
                lineNumbers: true,
                matchBrackets: true
            });
            editorCS.setSize($(this).width(), 25);
        });
    </script>

    <script type="text/javascript">
        function openWindowPredefinedModels()
        {
            var windowH = window.innerHeight;
            var windowW = window.innerWidth;

            var offsetH = windowH * 0.125;
            var childwH = windowH * 0.750;
            
            var offsetW = windowW * 0.125;
            var childwW = windowW * 0.750;
            
            var specificationsChildWindow = "";

            specificationsChildWindow += "resizable=0, ";
            specificationsChildWindow += "height=" + childwH.toString() + ", ";
            specificationsChildWindow += "width=" + childwW.toString() + ", ";
            specificationsChildWindow += "left=" + offsetW.toString() + ", ";
            specificationsChildWindow += "top=" + offsetH.toString() + ", ";

            var URL = "assets/predefinedModels.html";
            window.open(URL, "", specificationsChildWindow);
        }
    </script>
</head>
<body onload="WebGLInitializer()">
    <!-- The layout of the web page -->
    <header class="w3-container w3-black w3-center">
        <h5>Learning WebGL</h5>
    </header>

    <!--Our body, the beautiful stuff comes here-->
    <div class="w3-row-padding">
        <div class="w3-half">
            <input class="w3-container" id="inputURLImage" style="width:100%; height:35px;" type="text" value="images/GoogleAndroid.jpg" required>
        </div>
        <div class="w3-half">
            <a class="w3-btn w3-green" style="width:100%;" onclick="reloadTextureImage()">Load Image</a>
        </div>
    </div>
    
    <div class="w3-container">
        <canvas id="WebGLCanvas" style="width:100%; margin-left:auto; margin-right:auto; display:block"></canvas> 
    </div>
    <div class="w3-row-padding">
        <a class="w3-btn w3-green" style="float: left;" onclick="toggleAnimation()">Animate</a>
        <a class="w3-btn w3-red" style="float: left;" onclick="toggleTexture()">Toggle Texture</a>
        <a class="w3-btn w3-teal" style="float: left;" onclick="saveRender()">Save Render</a>
        <a class="w3-btn w3-blue" style="float: right;" onclick="loadShaders()">Compile</a>
        <a class="w3-btn w3-indigo" style="float:right;" onclick="openWindowPredefinedModels()">Choose Predefined 3D Model</a>
    </div>
    
    <div class="w3-row-padding">
        <div class="w3-half">
            <!-- Vertex shader input -->
            <div class="w3-container w3-indigo">
                <h4>Vertex Shader</h4>
            </div>
            <textarea type="text" cols="60" id="inputVS"></textarea> <br />
        </div>
        <div class="w3-half">
            <!-- Fragment shader input -->
            <div class="w3-container w3-indigo">
                <h4>Fragment Shader</h4>
            </div>
            <textarea type="text" cols="60" id="inputFS"></textarea> <br />
        </div>
    </div>
    <footer class="w3-container w3-black w3-center">
        <h5>&#169; Alejandro Guayaquil</h5>
    </footer>

    <!--Code syntax highlight http://codemirror.net/-->
    <script src="codemirror/lib/codemirror.js"></script>
    <script src="codemirror/addon/edit/matchbrackets.js"></script>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <script src="codemirror/mode/clike/clike.js"></script>

</body>
</html>